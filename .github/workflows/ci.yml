name: CI Pipeline

# When should this pipeline run?
on:
  push:
    branches: [ main, master ]  # Run on every push to main/master
  pull_request:
    branches: [ main, master ]  # Run on every pull request
  workflow_dispatch:            # Allow manual trigger

jobs:
  ci:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    # Step 1: Get our code
    - name: Checkout Code
      uses: actions/checkout@v4
      
    # Step 2: Setup Java 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # Step 3: Make Maven wrapper executable
    - name: Make mvnw executable
      run: chmod +x ./mvnw
        
    # Step 4: Cache Maven dependencies (makes builds faster)
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        
    # Step 4: Code Quality - Linting (Check code style)
    - name: Run Checkstyle
      run: ./mvnw checkstyle:check || echo "Checkstyle warnings found but continuing..."
      
    # Step 5: Security Scan - SAST (Static Application Security Testing)
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: java
        
    # Step 6: Build the application
    - name: Build with Maven
      run: ./mvnw clean compile
      
    # Step 7: Run Unit Tests
    - name: Run Tests
      run: ./mvnw test
      
    # Step 8: Package the application
    - name: Package Application
      run: ./mvnw package -DskipTests
      
    # Step 9: Security Scan - SCA (Software Composition Analysis)
    - name: Run OWASP Dependency Check
      run: |
        ./mvnw org.owasp:dependency-check-maven:check || echo "Dependency check completed with warnings"
        
    # Step 10: Complete CodeQL analysis
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      
    # Step 11: Build Docker Image
    - name: Build Docker Image
      run: |
        docker build -t number-validator:${{ github.sha }} .
        docker tag number-validator:${{ github.sha }} number-validator:latest
        
    # Step 12: Security Scan - Container Vulnerability Scan
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'number-validator:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    # Step 13: Upload Trivy scan results to GitHub Security tab
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
    # Step 14: Runtime Test - Test the Docker container
    - name: Test Docker Container
      run: |
        # Start container in background
        docker run -d -p 8080:8080 --name test-container number-validator:latest
        
        # Wait for container to start
        sleep 30
        
        # Test health endpoint
        curl -f http://localhost:8080/health || exit 1
        
        # Test our API
        curl -f http://localhost:8080/validate/4 | grep "even" || exit 1
        curl -f http://localhost:8080/validate/5 | grep "odd" || exit 1
        
        # Stop container
        docker stop test-container
        docker rm test-container
        
    # Step 15: Login to DockerHub
    - name: Login to DockerHub
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    # Step 16: Push to DockerHub (only on main branch)
    - name: Push to DockerHub
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        docker tag number-validator:latest ${{ secrets.DOCKERHUB_USERNAME }}/number-validator:latest
        docker tag number-validator:latest ${{ secrets.DOCKERHUB_USERNAME }}/number-validator:${{ github.sha }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/number-validator:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/number-validator:${{ github.sha }}